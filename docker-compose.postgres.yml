# OnlineTracker with PostgreSQL
# High-scale deployment with PostgreSQL database
#
# Usage:
#   docker compose -f docker-compose.postgres.yml up -d
#
# This file includes:
#   - PostgreSQL database with persistent storage
#   - OnlineTracker server configured for PostgreSQL
#   - Test agent (optional)

services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: onlinetracker-postgres
    environment:
      - POSTGRES_USER=onlinetracker
      - POSTGRES_PASSWORD=onlinetracker
      - POSTGRES_DB=onlinetracker
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U onlinetracker"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Main server instance with PostgreSQL
  onlinetracker-server:
    build: .
    container_name: onlinetracker-server
    environment:
      - MODE=server
      - WEB_PORT=8000
      - COMS_PORT=19443
      - DATABASE_URL=postgresql+asyncpg://onlinetracker:onlinetracker@postgres:5432/onlinetracker
    ports:
      - "${HOST_WEB_PORT:-8000}:8000"
      - "${HOST_COMS_PORT:-19443}:19443"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Test agent instance (optional)
  onlinetracker-agent:
    build: .
    container_name: onlinetracker-agent
    environment:
      - MODE=agent
      - AGENT_NAME=PostgreSQL-Agent
      - SERVER_HOST=onlinetracker-server
      - COMS_PORT=19443
      - SHARED_SECRET=test-secret-change-me
    volumes:
      - onlinetracker-agent-data:/data
    depends_on:
      - onlinetracker-server
    restart: unless-stopped

volumes:
  postgres-data:
  onlinetracker-agent-data:
