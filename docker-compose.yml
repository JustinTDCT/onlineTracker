# OnlineTracker Docker Compose
# Server with PostgreSQL database and optional agent
#
# The server runs TWO ports:
#   - WEB_PORT (8000): Web UI + full admin API - keep internal/protected
#   - COMS_PORT (19443): Agent API only - safe to expose for remote agents
#
# Host ports are configurable via environment variables:
#   HOST_WEB_PORT - Web UI port (default: 8000)
#   HOST_COMS_PORT - Agent communication port (default: 19443)
#
# Example: HOST_WEB_PORT=9000 docker compose up -d
# Or create a .env file with: HOST_WEB_PORT=9000

services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: onlinetracker-postgres
    environment:
      - POSTGRES_USER=onlinetracker
      - POSTGRES_PASSWORD=onlinetracker
      - POSTGRES_DB=onlinetracker
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U onlinetracker"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Main server instance
  onlinetracker-server:
    build: .
    container_name: onlinetracker-server
    environment:
      - MODE=server
      - WEB_PORT=8000
      - COMS_PORT=19443
      - DATABASE_URL=postgresql+asyncpg://onlinetracker:onlinetracker@postgres:5432/onlinetracker
    ports:
      - "${HOST_WEB_PORT:-8000}:8000"      # Web UI + Admin API (keep internal)
      - "${HOST_COMS_PORT:-19443}:19443"   # Agent API only (safe to expose)
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # Test agent instance
  # To use: set shared secret and allowed UUIDs in Settings first
  # COMS_PORT should match the server's agent API port (default 19443)
  onlinetracker-agent:
    build: .
    container_name: onlinetracker-agent
    environment:
      - MODE=agent
      - AGENT_NAME=TestAgent
      - SERVER_HOST=onlinetracker-server
      - COMS_PORT=19443
      - SHARED_SECRET=test-secret-change-me
    volumes:
      - onlinetracker-agent-data:/data
    depends_on:
      - onlinetracker-server
    restart: unless-stopped

volumes:
  postgres-data:
  onlinetracker-agent-data:
