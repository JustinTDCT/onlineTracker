# OnlineTracker Docker Compose
# Server and agent deployment
#
# The server runs TWO ports:
#   - WEB_PORT (8000): Web UI + full admin API - keep internal/protected
#   - COMS_PORT (19443): Agent API only - safe to expose for remote agents
#
# Host ports are configurable via environment variables:
#   HOST_WEB_PORT - Web UI port (default: 8000)
#   HOST_COMS_PORT - Agent communication port (default: 19443)
#
# Example: HOST_WEB_PORT=9000 docker compose up -d
# Or create a .env file with: HOST_WEB_PORT=9000

services:
  # Main server instance
  onlinetracker-server:
    build: .
    container_name: onlinetracker-server
    environment:
      - MODE=server
      - WEB_PORT=8000
      - COMS_PORT=19443
    ports:
      - "${HOST_WEB_PORT:-8000}:8000"      # Web UI + Admin API (keep internal)
      - "${HOST_COMS_PORT:-19443}:19443"   # Agent API only (safe to expose)
    volumes:
      - onlinetracker-data:/data
    restart: unless-stopped

  # Test agent instance
  # To use: set shared secret and allowed UUIDs in Settings first
  # COMS_PORT should match the server's agent API port (default 19443)
  onlinetracker-agent:
    build: .
    container_name: onlinetracker-agent
    environment:
      - MODE=agent
      - AGENT_NAME=TAB2
      - SERVER_HOST=onlinetracker-server
      - COMS_PORT=19443
      - SHARED_SECRET=test-secret-change-me
    volumes:
      - onlinetracker-agent-data:/data
    depends_on:
      - onlinetracker-server
    restart: unless-stopped

volumes:
  onlinetracker-data:
  onlinetracker-agent-data:
